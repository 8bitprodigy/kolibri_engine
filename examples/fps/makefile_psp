PROJECTNAME = fps_test
PLATFORM    = psp

SRCDIR      = ../../src
EXAMPLESDIR = ../
GAMESRCDIR  = .
OBJDIR      = obj/$(PLATFORM)

TARGET = $(PROJECTNAME).$(PLATFORM)
EXTRA_TARGETS = EBOOT.PBP
PSP_EBOOT_TITLE = Kolibri Engine Test

# Source files
ENGINE_SRC   = $(wildcard $(SRCDIR)/*.c)
EXAMPLES_SRC = $(wildcard $(EXAMPLESDIR)/*.c)
GAME_SRC     = $(wildcard $(GAMESRCDIR)/*.c)

# Don't separate engine/game objects - let PSP SDK handle it
ENGINE_OBJS   = $(ENGINE_SRC:$(SRCDIR)/%.c=$(OBJDIR)/engine/%.o)
EXAMPLES_OBJS = $(EXAMPLES_SRC:$(EXAMPLESDIR)/%.c=$(OBJDIR)/examples/%.o)
GAME_OBJS     = $(GAME_SRC:$(GAMESRCDIR)/%.c=$(OBJDIR)/game/%.o)

OBJS = $(ENGINE_OBJS) $(EXAMPLES_OBJS) $(GAME_OBJS)

# PSP SDK paths
PSPSDK = $(shell psp-config --pspsdk-path)
PSPDIR = $(shell psp-config --psp-prefix)

# EBOOT.PBP parameters
PSP_EBOOT_TITLE = Kolibri Engine FPS Test
PSP_EBOOT_ICON = NULL
PSP_EBOOT_PIC1 = NULL

# Compiler and flags
INCDIR = ../../include $(PSPDIR)/include/raylib $(PSPDIR)/include/raylib
CFLAGS    = -G0 -Wall -O0 -g3 -D__PSP__=1 -DSCREEN_HEIGHT=272 -DSCREEN_WIDTH=480
CFLAGS   += -D_PSP_FW_VERSION=661
CFLAGS   += -DPATH_PREFIX='"./"'
CFLAGS   += -DDEBUG
CFLAGS   += -DDEFAULT_MAX_RENDER_DISTANCE=256.0f
CFLAGS   += -DDEFAULT_TICK_RATE=35
CFLAGS   += -DMAX_NUM_ENTITIES=1024
CFLAGS   += -DSPATIAL_HASH_SIZE=1031
CFLAGS   += -DENTRY_POOL_SIZE=2048
CFLAGS   += -DVIS_QUERY_SIZE=1024
CFLAGS   += -DSKY_PATH='"resources/sky/SBS_SKY_panorama_half_%s.png"'
CFLAGS   += -DNO_MOUSE -DON_CONSOLE -DENGINE_SINGLE_HEAD_ONLY
CXXFLAGS  = $(CFLAGS) -fno-exceptions -fno-rtti
ASFLAGS   = $(CFLAGS)

# Libraries
LIBS = -lraylib -lpng -lz -lglut -lGLU -lGL -lpspvfpu -lpspaudio \
       -lm -lpspgum_vfpu -lpspvram -lpspgu -lpspge -lpspdisplay \
       -lpspctrl -lpspnet_inet -lpsppower -lpspnet -lpspnet_apctl \
       -lpspdebug -lpsputility -lpspuser 

# Build system
BUILD_PRX = 1

# Include PSP build rules FIRST
include $(PSPSDK)/lib/build.mak

.PHONY: prepare clean-all debug

rm-elf:
	rm -f $(TARGET)

prepare:
	mkdir -p $(OBJDIR)
	mkdir -p $(OBJDIR)/engine
	mkdir -p $(OBJDIR)/examples
	mkdir -p $(OBJDIR)/game
	
# Add custom rules for compiling from different directories
$(OBJDIR)/engine/%.o: $(SRCDIR)/%.c | $(OBJDIR)/engine
	$(CC) $(CFLAGS) $(INCDIR:%=-I%) -c $< -o $@

$(OBJDIR)/examples/%.o: $(EXAMPLESDIR)/%.c | $(OBJDIR)/examples
	$(CC) $(CFLAGS) $(INCDIR:%=-I%) -c $< -o $@

$(OBJDIR)/game/%.o: $(GAMESRCDIR)/%.c | $(OBJDIR)/game
	$(CC) $(CFLAGS) $(INCDIR:%=-I%) -c $< -o $@

# Directory creation rules
$(OBJDIR)/engine $(OBJDIR)/examples $(OBJDIR)/game:
	mkdir -p $@


clean-all:
	rm -rf obj
	rm -f $(TARGET).elf $(TARGET).prx EBOOT.PBP PARAM.SFO

debug:
	@echo "PLATFORM:       $(PLATFORM)"
	@echo "ENGINE_SOURCES: $(ENGINE_SRC)"
	@echo "GAME_SOURCES:   $(GAME_SRC)"
	@echo "OBJS:           $(OBJS)"
	@echo "PSPSDK:         $(PSPSDK)"
	@echo "PSPDIR:         $(PSPDIR)"
